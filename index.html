<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Levin Eyecare | Contact Lens Catalog</title>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#fff; color:#000; }
  h1 { margin: 0 0 6px; }
  .sub { margin: 0 0 14px; color:#444; }
  .note { background:#fff7e6; border:1px solid #ffd27a; padding:12px; border-radius:6px; margin-bottom:16px; }
  .controls { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px; align-items:flex-end; }
  label { font-size:12px; display:block; margin-bottom:4px; }
  .status { margin: 10px 0; font-size: 13px; color: #555; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border:1px solid #ddd; padding:8px; vertical-align:top; }
  th { background:#f3f3f3; position:sticky; top:0; }
  .right { text-align:right; white-space:nowrap; }
  .good { font-weight:bold; }
  .pos { color:#0a7a2f; font-weight:bold; }
  .neg { color:#b00020; font-weight:bold; }

  .btnrow { display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 0; }
  .pillbtn {
    border:2px solid #000; background:#fff; color:#000;
    border-radius:999px; padding:6px 12px; cursor:pointer; font-size:13px;
  }
  .pillbtn:hover { background:#f5f5f5; }
</style>
</head>

<body>
<h1>Contact Lens Catalog (v1.2)</h1>
<div class="sub">Central pricing + rebate comparison vs 1-800 Contacts</div>

<div class="note">
  <b>How this works:</b> Search a lens → select New/Existing → choose annual boxes → compare Levin net vs 1-800 net.
  <div style="font-size:12px;color:#666;margin-top:6px;">
    Version 1.2 adds filters + box presets. Data updates from the Google Sheet automatically.
  </div>
</div>

<div class="controls">
  <div>
    <label>Search</label>
    <input id="q" placeholder="Acuvue, Biofinity, Dailies"
      style="width:300px;height:40px;padding:8px;border:2px solid #000;border-radius:4px;background:#fff;color:#000;font-size:14px;-webkit-text-fill-color:#000;caret-color:#000;">
  </div>

  <div>
    <label>Brand</label>
    <select id="brandFilter"
      style="width:240px;height:40px;padding:8px;border:2px solid #000;border-radius:4px;background:#fff;color:#000;font-size:14px;">
      <option value="">All Brands</option>
    </select>
  </div>

  <div>
    <label>Modality</label>
    <select id="modalityFilter"
      style="width:240px;height:40px;padding:8px;border:2px solid #000;border-radius:4px;background:#fff;color:#000;font-size:14px;">
      <option value="">All Modalities</option>
    </select>
  </div>

  <div>
    <label>Rebate Type</label>
    <select id="wearer"
      style="width:220px;height:40px;padding:8px;border:2px solid #000;border-radius:4px;background:#fff;color:#000;font-size:14px;">
      <option value="new">New wearer</option>
      <option value="existing">Existing wearer</option>
    </select>
  </div>

  <div>
    <label>Annual Boxes</label>
    <input id="annualBoxes" type="number" value="8" min="0"
      style="width:120px;height:40px;padding:8px;border:2px solid #000;border-radius:4px;background:#fff;color:#000;font-size:14px;-webkit-text-fill-color:#000;caret-color:#000;">
    <div class="btnrow">
      <button class="pillbtn" data-box="4">4</button>
      <button class="pillbtn" data-box="6">6</button>
      <button class="pillbtn" data-box="8">8</button>
      <button class="pillbtn" data-box="12">12</button>
    </div>
  </div>

  <div>
    <button id="reload"
      style="height:40px;padding:8px 14px;border:2px solid #000;border-radius:6px;background:#fff;cursor:pointer;">
      Reload Catalog
    </button>
  </div>
</div>

<div class="status" id="status">Loading catalog…</div>

<table>
<thead>
<tr>
  <th>Lens</th>
  <th>Specs</th>
  <th class="right">Levin / Box</th>
  <th class="right">1-800 / Box</th>
  <th class="right">Levin Net</th>
  <th class="right">1-800 Net</th>
  <th class="right">Savings</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSgUS_6mZIxKMPAT5xSAuzKELghIeOsySrfpb3R-h0mXyaPHM3d9xXT4aWr5uApY7XFdysA5jg28g2c/pub?gid=0&single=true&output=csv";

const els = {
  q: document.getElementById("q"),
  brandFilter: document.getElementById("brandFilter"),
  modalityFilter: document.getElementById("modalityFilter"),
  wearer: document.getElementById("wearer"),
  annualBoxes: document.getElementById("annualBoxes"),
  rows: document.getElementById("rows"),
  status: document.getElementById("status"),
  reload: document.getElementById("reload")
};

let data = [];

function money(n){
  if(!isFinite(n)) return "—";
  return "$" + n.toFixed(2);
}
function num(v){
  const s = String(v ?? "").replace(/[$,]/g,"").trim();
  if(s === "") return NaN;
  const n = Number(s);
  return isFinite(n) ? n : NaN;
}
function splitCSVLine(line){
  const out = [];
  let cur = "", inQuotes = false;
  for (let i = 0; i < line.length; i++){
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { cur += '"'; i++; continue; }
      inQuotes = !inQuotes; continue;
    }
    if (!inQuotes && ch === ',') { out.push(cur); cur = ""; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  const headers = splitCSVLine(lines[0]).map(h => h.trim());
  return lines.slice(1).map(line=>{
    const values = splitCSVLine(line);
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (values[i] ?? "").trim());
    return obj;
  });
}

function setDropdownOptions(selectEl, items, allLabel){
  const current = selectEl.value;
  selectEl.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = allLabel;
  selectEl.appendChild(optAll);

  items.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  });

  // restore selection if possible
  if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
}

function render(){
  const term = els.q.value.toLowerCase();
  const boxes = Number(els.annualBoxes.value || 0);
  const brand = els.brandFilter.value;
  const modality = els.modalityFilter.value;

  const filtered = data.filter(r => {
    const hay = [r.Brand, r.LensName, r.Modality, r.Type].join(" ").toLowerCase();
    if (term && !hay.includes(term)) return false;
    if (brand && (r.Brand || "") !== brand) return false;
    if (modality && (r.Modality || "") !== modality) return false;
    return true;
  });

  els.rows.innerHTML = "";

  for(const r of filtered){
    const lp = num(r.RetailPerBox);
    const cp = num(r.CompetitorPerBox);
    const lr = num(els.wearer.value==="new" ? r.RebateAnnualNew : r.RebateAnnualExisting);
    const cr = num(els.wearer.value==="new" ? r.CompetitorRebateNew : r.CompetitorRebateExisting);

    const levinNet = (isFinite(lp) ? lp * boxes : NaN) - (isFinite(lr) ? lr : 0);
    const compNet  = (isFinite(cp) ? cp * boxes : NaN) - (isFinite(cr) ? cr : 0);
    const diff = compNet - levinNet;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${r.Brand || ""}</b><br>${r.LensName || ""}<div style="font-size:12px;color:#666;">${r.Type || ""}</div></td>
      <td style="font-size:12px;color:#666;">
        BC ${(r["Base Curve"] || r.BaseCurve || "")} • DIA ${(r.Diameter || "")}<br>
        ${r.Modality || ""} • Lenses/Box ${(r.LensesPerBox || "")}
      </td>
      <td class="right">${money(lp)}</td>
      <td class="right">${money(cp)}</td>
      <td class="right good">${money(levinNet)}</td>
      <td class="right good">${money(compNet)}</td>
      <td class="right ${isFinite(diff) && diff>=0 ? 'pos':'neg'}">${money(diff)}</td>
    `;
    els.rows.appendChild(tr);
  }

  els.status.textContent = `Loaded ${data.length} lenses. Showing ${filtered.length}.`;
}

async function load(){
  try{
    els.status.textContent = "Loading catalog…";
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
